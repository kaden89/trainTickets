# Система покупки ж/д билетов

# Принцип работы:

1) Пользователь авторизуется в приложении<br />
2) По дате и пункту отправления/прибытия получает список возможных поездок на эту дату<br />
3) По выбранной поездке получает список доступных к бронированию билетов<br />
4) Бронирует нужный билет (по умолчанию на 10 мин)<br />
5) Совершает покупку забронированного билета<br />

# Rest API
<b>Список поездок:</b> `GET /api/v1/trips/?departureId=1&destinationId=2&date=2017-09-1`<br />
<b>Список доступных билетов поездки (без купленных и забронированных):</b>`GET /api/v1/trips/{tripId}/tickets`<br />
<b>Бронирование билета:</b>`POST /api/v1/trips/{tripId}/tickets/{ticketId}/reserve`<br />
<b>Покупка билета:</b>`POST /api/v1/trips/{tripId}/tickets/{ticketId}/buy`<br />

# Реализация:
<b>Схема БД:</b> <br />
Справочные таблицы: Пользователи(USERS), Города(CITIES), Поезда(TRAINS), Вагоны(WAGONS)<br />
Связочные таблицы: <br />
Таблица Поездки(TRIPS) - Отражает запланированные маршруты, ссылается на города (отправка/прибытие), поезд и билеты на этот маршрут. Содержит информацию о дате и времени отбытия/прибытия
Таблица Бронирования(RESERVATIONS) - Отражает историю бронирования билетов. Ссылкается на билет и забронировавшего юзера. Содержит информацию о дате окончания бронирования.   
Таблица Билеты(TICKETS) - Ссылается на маршрут, вагон, купишего пользователя(Если не куплен тут будет NULL). Содержит информацию о цене и номере места
Индексы по поисковым полям<br />
<br />
<b>Программная реализация:</b> <br />
Слоистая архитектура(модель-дао-сервис-веб). Стандартный CRUD + логика необходимая для покупки билетов. Базовое покрытие логики тестами. 
Стоит выделить систему бронирования. Для решения проблемы истекшего бронирования используется следующий подход:<br />
При попытке бронирования билета происходит запрос к таблице бронирования который сравнивает текущее время с максимальным из таблицы бронирования для конкретного билета.
Если текущее время больше либо таблица бронирования пуста, то пользователю разрешается забронировать билет. 
Создается запись в таблице бронирования с истекающим временем по формуле: текущее время + 10мин. Таким образом если в течении 10 мин билет не будет куплен, он автоматически станет виден и доступен для бронирования другим пользователям.
Чтобы избежать возможности бронирования одного и того же билета несколькими пользователями применяется оптимистичная блокировка по таблице билета, путем принудительного повышения версии билета при бронировании.

